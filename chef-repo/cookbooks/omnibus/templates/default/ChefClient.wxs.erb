<?xml version='1.0'?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi" xmlns:util="http://schemas.microsoft.com/wix/UtilExtension">

  <!-- This is how we include wxi files -->
  <?include "<%= @global_config %>" ?>

  <!--
    Id="*" is to enable upgrading. * means that the product ID will be autogenerated on each build.
    Name is made of localized product name and version number.
  -->
  <Product Id="*" Name="!(loc.ProductName) v$(var.DisplayVersionNumber)" Language="!(loc.LANG)"
    Version="$(var.VersionNumber)" Manufacturer="!(loc.ManufacturerName)" UpgradeCode="$(var.UpgradeCode)">

    <!--
      Define the minimum supported installer version (2.0).
      The install should be done for the whole machine not just the current user
    -->
    <Package InstallerVersion="200" InstallPrivileges="elevated"
             Compressed="yes" InstallScope="perMachine" />

    <Media Id="1" Cabinet="ChefClient.cab" EmbedCab="yes" CompressionLevel="high" />

    <!-- Upgrade settings. -->
    <MajorUpgrade
      DowngradeErrorMessage="A later version of [ProductName] is already installed. Setup will now exit." />

    <Directory Id="TARGETDIR" Name="SourceDir">
      <Directory Id="WindowsVolume">
        <Directory Id="INSTALLLOCATION" Name="opscode">
          <Directory Id="CHEFLOCATION" Name="chef" >
            <Directory Id="EMBEDDED" Name="embedded" >
              <Directory Id="EMBEDDEDBIN" Name="bin" >
                <Component Id="ChefClientPath" Guid="{7F663F88-55A2-4E20-82BF-8BD2E60BB83A}" >
                  <!-- TODO remove [CHEFLOCATION]\embedded\bin once CHEF-2681 is fixed -->
                  <Environment Id="Environment"
                    Name="PATH" Action="set" Part="last" System="yes" Value="[CHEFLOCATION]bin;[CHEFLOCATION]embedded\bin" />
                </Component>
                <Component Id="ChefClientService" Guid="{69B2D8BE-4A47-4BE3-AEE8-83FAEB6E2FAF}" >
                  <File Id="RubyExecutable" Source="$(var.ChefClientSourceDir)\embedded\bin\ruby.exe" KeyPath="yes" />
                  <ServiceInstall Name="chef-client" Type="ownProcess"
                    Start="auto" Vital="yes" ErrorControl="ignore"
                    Arguments="[CHEFLOCATION]embedded\lib\ruby\gems\1.9.1\gems\chef-0.$(var.DisplayVersionNumber)\lib\chef\application\windows_service.rb"
                    DisplayName="!(loc.ServiceDisplayName)"
                    Description="!(loc.ServiceDescription)" />
                  <ServiceControl Id="ControlChefClientService" Name="ChefClientService"
                    Remove="both" Stop="both" Wait="yes" />
                </Component>
              </Directory>
            </Directory>
          </Directory>
        </Directory>
      </Directory>
    </Directory>

    <!-- Set the components defined in our fragment files that will be used for our feature  -->
    <Feature Id="ChefClientFeature" Title="!(loc.ProductName)" Level="1" Absent="disallow" AllowAdvertise="no"
    ConfigurableDirectory="INSTALLLOCATION">
      <ComponentGroupRef Id="<%= @files_component_group %>" />
      <ComponentRef Id="ChefClientPath" />
      <ComponentRef Id="ChefClientService" />
    </Feature>

    <Feature Id="ChefServiceFeature" Title="!(loc.ServiceName)" Level="1000" AllowAdvertise="no">
      <ComponentRef Id="ChefClientService" />
    </Feature>

    <!--
      TODO:

      * fix icon issues (ie they don't work)
      * create Chef home directory. (C:\chef)
      * perform initial 'bootstrap' steps. (write out C:\chef\client.rb and C:\chef\validatio.pem)
      * optionally install extra tools?  ie git?

    -->

    <!--
      UI Stuff
    -->
    <Icon Id="oc.exe" SourceFile="<%= @assets_dir %>\oc.ico"/>
    <Property Id="ARPPRODUCTICON" Value="oc.exe" />
    <Property Id="ARPHELPLINK" Value="http://help.opscode.com/" />
    <Property Id="WIXUI_INSTALLDIR" Value="INSTALLLOCATION" />

    <UIRef Id="ChefClientUI_InstallDir"/>
    <UI Id="ChefClientUI_InstallDir">
      <UIRef Id="WixUI_FeatureTree"/>
      <TextStyle Id="WixUI_Font_Normal_White" FaceName="Tahoma" Size="8" Red="255" Green="255" Blue="255" />
      <TextStyle Id="WixUI_Font_Bigger_White" FaceName="Tahoma" Size="12" Red="255" Green="255" Blue="255" />
      <TextStyle Id="WixUI_Font_Title_White" FaceName="Tahoma" Size="9" Bold="yes" Red="255" Green="255" Blue="255" />
    </UI>

    <WixVariable Id="WixUILicenseRtf" Value="<%= @assets_dir %>\LICENSE.rtf" />
    <WixVariable Id="WixUIDialogBmp" Value="<%= @assets_dir %>\dialog_background.bmp" />
    <WixVariable Id="WixUIBannerBmp" Value="<%= @assets_dir %>\banner_background.bmp" />

    <!--<WixVariable Id="WixUIExclamationIco" Value="<%= @assets_dir %>\oc_32x32.ico" />
    <WixVariable Id="WixUIInfoIco" Value="<%= @assets_dir %>\oc_32x32.ico" />
    <WixVariable Id="WixUINewIco" Value="<%= @assets_dir %>\oc_16x16.ico" />
    <WixVariable Id="WixUIUpIco" Value="<%= @assets_dir %>\oc_16x16.ico" />-->

  </Product>
</Wix>
